// Bibliothèques
import React, { useState } from "react";
import ReactDOMServer from "react-dom/server";
import { useNavigate } from "react-router-dom";
import "../../style/jquery.dataTables.min.css";
import language_fr from "../../style/language_fr";
import $ from "jquery";
import axios from "axios";
import "jquery";
import "datatable";
import "datatables.net";
import "datatables.net-dt";
import "datatables.net-buttons";

// Composantstype
import FormSeance from "../Formulaires/FormSeance";
import FormSalle from "../Formulaires/FormSalle";
import FormCours from "../Formulaires/FormCours";
import FormEnseignant from "../Formulaires/FormEnseignant";
import FormModule from "../Formulaires/FormModule";
import FormConfirmation from "../Formulaires/FormConfirmation";

// Code
function TableauComplet({
  url,
  fetchData,
  itemAdd,
  data,
  type,
  dom,
  columns,
  nameColumns,
  buttons,
  ordering,
}) {
  const tableRef = useRef(null);
  const [modalEdit, setModalEdit] = useState(false);
  const [modalCreate, setModalCreate] = useState(false);
  const [item, setItem] = useState(null);
  const [modalRemove, setModalRemove] = useState(false);
  const navigate = useNavigate();

  useEffect(() => {
    $(tableRef.current).DataTable({
      dom: dom,
      language: language_fr,
      data: data,
      columns: columns,
      autoWidth: true,
      order: [[0, "asc"]],
      columnDefs: [
        { orderable: ordering, targets: "_all" },
        {
          targets: -1,
          render: function (data, type) {
            if (buttons !== "") {
              // Si des boutons sont précisés, on les affiche dans la dernière colonne
              return ReactDOMServer.renderToString(buttons);
            } else {
              // Sinon on applique le comportement par défaut de DataTable
              if (type === "display" || type === "filter") {
                return data;
              }
              return "";
            }
          },
        },
      ],
      buttons: [
        {
          text: "Ajouter",
          className: "btn btn-success",
          action: function (e, dt, node, config) {
            // Action à exécuter lors du clic sur le bouton "Ajouter"
            toggleModalCreate();
          },
        },
      ],
    });

    // Paramètres du corps du tableau.
    $(tableRef.current).on("click", "button", function () {
      var action = this.className;
      var data = new_table.row($(this).parents("tr")).data();

      if (data !== undefined) {
        if (action !== undefined) {
          // Si c'est le bouton "Fiche Programme" de la liste des modules
          if ((type = "cours") && action === "btn btn-secondary btn-sm w-70") {
            redirect(`/modules/${data.id}/FicheProgramme`);
          }
          // Si c'est le bouton "Planification" de la liste des modules
          else if ((type = "cours") && action === "btn btn-dark btn-sm w-70") {
            redirect(`/modules/${data.id}/PlanificationModule`);
          }
          // Si c'est le bouton "Dupliquer" de la liste des séances
          else if (
            (type = "seances") &&
            action === "btn btn-success btn-sm w-70"
          ) {
            duplicate(data);
          }
          // Si c'est bouton "modifier"
          else if (action === "btn btn-warning btn-sm w-70") {
            toggleModalEdit(data);
          }
          // Si c'est bouton "supprimer"
          else if (action === "btn btn-danger btn-sm w-70") {
            toggleModalRemove(data);
          }
        }
      }
    });
  }, [data, columns]);

  // Fonction permettant de rediriger l'utilisateur vers l'URL passée en paramètre.
  function redirect(url) {
    navigate(url);
  }

  // Fonction permettant d'afficher ou de cacher le formulaire de suppression.
  // Le formulaire affiché dépend du paramètre 'type' passé en paramètre du composant.
  function toggleModalEdit(item) {
    setItem(item);
    setModalEdit(!modalEdit);
  }

  // Fonction permettant d'envoyer la modification de l'item dans la base de données.
  // Cette fonction est appelée après l'affichage du formulaire, au moment où l'utilisateur
  // appuie sur le bouton 'Enregistrer'. Remarquez que le formulaire est cachée au lancement
  // de la fonction puis une requête PATCH est faite à l'API.
  function edit(itemModified) {
    toggleModalEdit(itemModified);
    axios
      .patch(`${url}${itemModified.id}/`, itemModified)
      .then(() => {
        fetchData();
      })
      .catch((error) => {
        console.error(error);
      });
  }

  // Fonction permettant d'afficher ou de cacher le formulaire de suppression.
  // Le formulaire affiché dépend du paramètre 'type' passé en paramètre du composant.
  function toggleModalRemove(item) {
    setItem(item);
    setModalRemove(!modalRemove);
  }

  // Fonction permettant d'afficher ou de cacher le formulaire de création.
  // Le formulaire affiché dépend du paramètre 'type' passé en paramètre du composant.
  function toggleModalCreate() {
    setModalCreate(!modalCreate);
  }

  // Fonction permettant d'envoyer la création de l'item dans la base de données.
  // Cette fonction est appelée après l'affichage du formulaire, au moment où l'utilisateur
  // appuie sur le bouton 'Enregistrer'. Remarquez que le formulaire est cachée au lancement
  // de la fonction puis une requête PATCH est faite à l'API.
  function create(item) {
    toggleModalCreate();
    axios
      .post(url, item)
      .then(() => {
        fetchData();
      })
      .catch((error) => {
        console.error(error);
      });
  }

  // Fonction permettant de dupliquer l'objet sélectionné.
  function duplicate(item) {
    delete item.id;
    axios
      .post(url, item)
      .then(() => {
        fetchData();
      })
      .catch((error) => {
        console.error(error);
      });
  }

  // Fonction permettant d'envoyer la suppression de l'item dans la base de données.
  // Cette fonction est appelée après l'affichage du formulaire, au moment où l'utilisateur
  // appuie sur le bouton 'Enregistrer'. Remarquez que le formulaire est cachée au lancement
  // de la fonction puis une requête PATCH est faite à l'API.
  function remove(id) {
    setModalRemove(!modalRemove);
    axios
      .delete(`${url}${id}/`)
      .then(() => {
        fetchData();
      })
      .catch((error) => {
        console.error(error);
      });
  }

  return (
    <div className="container-fluid py-4">
      <div className="table-responsive p-0 pb-2">
        <table id="datatable" className="display" ref={tableRef}>
          <thead>
            <tr>
              {nameColumns.map((colonne) => (
                <th key={colonne} className="th-sm">
                  {colonne}
                </th>
              ))}
            </tr>
          </thead>
        </table>
      </div>

      <FormConfirmation
        isOpen={modalRemove}
        toggle={toggleModalRemove}
        onSave={() => remove(item.id)}
        item={item}
      />

      {type === "cours" && modalEdit && (
        <FormCours
          isOpen={modalEdit}
          toggle={toggleModalEdit}
          activeItem={item}
          onSave={edit}
          title="Modification d'un cours"
        />
      )}

      {type === "enseignants" && modalEdit && (
        <FormEnseignant
          isOpen={modalEdit}
          toggle={toggleModalEdit}
          activeItem={item}
          onSave={edit}
          title="Modification d'un enseignant"
        />
      )}

      {type === "modules" && modalEdit && (
        <FormModule
          isOpen={modalEdit}
          toggle={toggleModalEdit}
          activeItem={item}
          onSave={edit}
          title="Modification d'un mpdule"
        />
      )}

      {type === "salles" && modalEdit && (
        <FormSalle
          isOpen={modalEdit}
          toggle={toggleModalEdit}
          activeItem={item}
          onSave={edit}
          title="Modification d'une salle"
        />
      )}

      {type === "seances" && modalEdit && (
        <FormSeance
          isOpen={modalEdit}
          toggle={toggleModalEdit}
          activeItem={item}
          onSave={edit}
          title="Modification d'une séance"
        />
      )}

      {type === "cours" && modalCreate && (
        <FormCours
          isOpen={modalCreate}
          toggle={toggleModalCreate}
          activeItem={itemAdd}
          onSave={create}
          title="Ajout d'un cours"
        />
      )}

      {type === "enseignants" && modalCreate && (
        <FormEnseignant
          isOpen={modalCreate}
          toggle={toggleModalCreate}
          activeItem={itemAdd}
          onSave={create}
          title="Ajout d'un enseignant"
        />
      )}

      {type === "modules" && modalCreate && (
        <FormModule
          isOpen={modalCreate}
          toggle={toggleModalCreate}
          activeItem={itemAdd}
          onSave={create}
          title="Ajout d'un module"
        />
      )}

      {type === "salles" && modalCreate && (
        <FormSalle
          isOpen={modalCreate}
          toggle={toggleModalCreate}
          activeItem={itemAdd}
          onSave={create}
          title="Ajout d'une salle"
        />
      )}

      {type === "seances" && modalCreate && (
        <FormSeance
          isOpen={modalCreate}
          toggle={toggleModalCreate}
          activeItem={itemAdd}
          onSave={create}
          title="Ajout d'une séance"
        />
      )}
    </div>
  );
}

export default TableauComplet;
